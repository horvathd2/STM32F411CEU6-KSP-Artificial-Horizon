/*
 * trig_lookup_tables.c
 *
 *  Created on: Jan 12, 2026
 *      Author: H.Dani
 */
#include "trig_lookup_tables.h"
#include "navball_texture_256_128.h"
#include "main.h"
#include "math.h"

static uint16_t framebuffer[FB_WIDTH * FB_HEIGHT];

const float sin_table[TABLE_SIZE] = {
          0.0f,      0.01f,  0.019999f,  0.029996f,  0.039989f,  0.049979f,  0.059964f,  0.069943f,
     0.079915f,  0.089879f,  0.099833f,  0.109778f,  0.119712f,  0.129634f,  0.139543f,  0.149438f,
     0.159318f,  0.169182f,   0.17903f,  0.188859f,  0.198669f,   0.20846f,   0.21823f,  0.227978f,
     0.237703f,  0.247404f,  0.257081f,  0.266731f,  0.276356f,  0.285952f,   0.29552f,  0.305059f,
     0.314567f,  0.324043f,  0.333487f,  0.342898f,  0.352274f,  0.361615f,   0.37092f,  0.380188f,
     0.389418f,  0.398609f,   0.40776f,  0.416871f,  0.425939f,  0.434966f,  0.443948f,  0.452886f,
     0.461779f,  0.470626f,  0.479426f,  0.488177f,   0.49688f,  0.505533f,  0.514136f,  0.522687f,
     0.531186f,  0.539632f,  0.548024f,  0.556361f,  0.564642f,  0.572867f,  0.581035f,  0.589145f,
     0.597195f,  0.605186f,  0.613117f,  0.620986f,  0.628793f,  0.636537f,  0.644218f,  0.651834f,
     0.659385f,   0.66687f,  0.674288f,  0.681639f,  0.688921f,  0.696135f,  0.703279f,  0.710353f,
     0.717356f,  0.724287f,  0.731146f,  0.737931f,  0.744643f,   0.75128f,  0.757843f,  0.764329f,
     0.770739f,  0.777072f,  0.783327f,  0.789504f,  0.795602f,   0.80162f,  0.807558f,  0.813416f,
     0.819192f,  0.824886f,  0.830497f,  0.836026f,  0.841471f,  0.846832f,  0.852108f,  0.857299f,
     0.862404f,  0.867423f,  0.872355f,  0.877201f,  0.881958f,  0.886627f,  0.891207f,  0.895699f,
       0.9001f,  0.904412f,  0.908633f,  0.912764f,  0.916803f,  0.920751f,  0.924606f,  0.928369f,
     0.932039f,  0.935616f,  0.939099f,  0.942489f,  0.945784f,  0.948985f,   0.95209f,  0.955101f,
     0.958016f,  0.960835f,  0.963558f,  0.966185f,  0.968715f,  0.971148f,  0.973485f,  0.975723f,
     0.977865f,  0.979908f,  0.981854f,  0.983701f,   0.98545f,    0.9871f,  0.988652f,  0.990105f,
     0.991458f,  0.992713f,  0.993868f,  0.994924f,  0.995881f,  0.996738f,  0.997495f,  0.998152f,
      0.99871f,  0.999168f,  0.999526f,  0.999784f,  0.999942f,       1.0f,  0.999958f,  0.999816f,
     0.999574f,  0.999232f,   0.99879f,  0.998248f,  0.997606f,  0.996865f,  0.996024f,  0.995083f,
     0.994043f,  0.992904f,  0.991665f,  0.990327f,   0.98889f,  0.987354f,  0.985719f,  0.983986f,
     0.982154f,  0.980224f,  0.978197f,  0.976071f,  0.973848f,  0.971527f,  0.969109f,  0.966594f,
     0.963983f,  0.961275f,  0.958471f,  0.955572f,  0.952576f,  0.949486f,    0.9463f,   0.94302f,
     0.939645f,  0.936177f,  0.932615f,   0.92896f,  0.925212f,  0.921371f,  0.917438f,  0.913413f,
     0.909297f,  0.905091f,  0.900793f,  0.896406f,  0.891929f,  0.887362f,  0.882707f,  0.877964f,
     0.873133f,  0.868215f,  0.863209f,  0.858118f,   0.85294f,  0.847678f,   0.84233f,  0.836899f,
     0.831383f,  0.825785f,  0.820104f,  0.814341f,  0.808496f,  0.802571f,  0.796565f,   0.79048f,
     0.784316f,  0.778073f,  0.771753f,  0.765355f,  0.758881f,  0.752331f,  0.745705f,  0.739005f,
     0.732231f,  0.725384f,  0.718465f,  0.711473f,  0.704411f,  0.697278f,  0.690075f,  0.682803f,
     0.675463f,  0.668056f,  0.660581f,  0.653041f,  0.645435f,  0.637765f,  0.630031f,  0.622234f,
     0.614374f,  0.606454f,  0.598472f,  0.590431f,  0.582331f,  0.574172f,  0.565956f,  0.557684f,
     0.549355f,  0.540972f,  0.532535f,  0.524044f,  0.515501f,  0.506907f,  0.498262f,  0.489567f,
     0.480823f,  0.472031f,  0.463191f,  0.454306f,  0.445375f,  0.436399f,   0.42738f,  0.418318f,
     0.409214f,  0.400069f,  0.390885f,  0.381661f,  0.372399f,    0.3631f,  0.353764f,  0.344393f,
     0.334988f,  0.325549f,  0.316078f,  0.306575f,  0.297041f,  0.287478f,  0.277886f,  0.268266f,
     0.258619f,  0.248947f,  0.239249f,  0.229528f,  0.219784f,  0.210017f,   0.20023f,  0.190423f,
     0.180596f,  0.170752f,   0.16089f,  0.151013f,   0.14112f,  0.131213f,  0.121293f,  0.111361f,
     0.101418f,  0.091465f,  0.081502f,  0.071532f,  0.061554f,   0.05157f,  0.041581f,  0.031587f,
     0.021591f,  0.011592f,  0.001593f, -0.008407f, -0.018406f, -0.028404f, -0.038398f, -0.048388f,
    -0.058374f, -0.068354f, -0.078327f, -0.088292f, -0.098249f, -0.108195f, -0.118131f, -0.128055f,
    -0.137966f, -0.147863f, -0.157746f, -0.167612f, -0.177462f, -0.187295f, -0.197108f, -0.206902f,
    -0.216675f, -0.226427f, -0.236155f, -0.245861f, -0.255541f, -0.265196f, -0.274825f, -0.284426f,
    -0.293998f, -0.303542f, -0.313054f, -0.322536f, -0.331985f, -0.341401f, -0.350783f,  -0.36013f,
    -0.369441f, -0.378715f, -0.387951f, -0.397148f, -0.406306f, -0.415423f, -0.424498f, -0.433531f,
     -0.44252f, -0.451466f, -0.460366f,  -0.46922f, -0.478027f, -0.486787f, -0.495497f, -0.504159f,
    -0.512769f, -0.521329f, -0.529836f, -0.538291f, -0.546691f, -0.555037f, -0.563327f, -0.571561f,
    -0.579738f, -0.587857f, -0.595917f, -0.603918f, -0.611858f, -0.619737f, -0.627554f, -0.635308f,
    -0.642999f, -0.650625f, -0.658186f, -0.665682f, -0.673111f, -0.680473f, -0.687766f, -0.694991f,
    -0.702146f, -0.709231f, -0.716246f, -0.723188f, -0.730058f, -0.736856f, -0.743579f, -0.750228f,
    -0.756802f, -0.763301f, -0.769723f, -0.776068f, -0.782336f, -0.788525f, -0.794636f, -0.800667f,
    -0.806618f, -0.812488f, -0.818277f, -0.823984f, -0.829609f, -0.835151f, -0.840609f, -0.845984f,
    -0.851273f, -0.856478f, -0.861597f,  -0.86663f, -0.871576f, -0.876435f, -0.881206f, -0.885889f,
    -0.890484f, -0.894989f, -0.899405f, -0.903732f, -0.907967f, -0.912112f, -0.916166f, -0.920128f,
    -0.923998f, -0.927776f, -0.931461f, -0.935053f, -0.938551f, -0.941955f, -0.945266f, -0.948481f,
    -0.951602f, -0.954628f, -0.957558f, -0.960392f, -0.963131f, -0.965773f, -0.968319f, -0.970767f,
    -0.973119f, -0.975373f,  -0.97753f, -0.979589f,  -0.98155f, -0.983413f, -0.985178f, -0.986844f,
    -0.988411f,  -0.98988f, -0.991249f,  -0.99252f, -0.993691f, -0.994763f, -0.995735f, -0.996608f,
    -0.997381f, -0.998054f, -0.998628f, -0.999102f, -0.999476f, -0.999749f, -0.999923f, -0.999997f,
    -0.999971f, -0.999845f, -0.999619f, -0.999293f, -0.998867f, -0.998341f, -0.997715f,  -0.99699f,
    -0.996165f,  -0.99524f, -0.994216f, -0.993092f, -0.991869f, -0.990547f, -0.989125f, -0.987605f,
    -0.985986f, -0.984269f, -0.982453f, -0.980538f, -0.978526f, -0.976416f, -0.974208f, -0.971903f,
    -0.969501f, -0.967001f, -0.964405f, -0.961713f, -0.958924f,  -0.95604f,  -0.95306f, -0.949984f,
    -0.946814f, -0.943549f, -0.940189f, -0.936736f, -0.933189f, -0.929548f, -0.925815f, -0.921989f,
     -0.91807f,  -0.91406f, -0.909959f, -0.905767f, -0.901484f, -0.897111f, -0.892648f, -0.888096f,
    -0.883455f, -0.878725f, -0.873908f, -0.869004f, -0.864012f, -0.858934f, -0.853771f, -0.848522f,
    -0.843188f, -0.837769f, -0.832267f, -0.826682f, -0.821014f, -0.815264f, -0.809433f,  -0.80352f,
    -0.797527f, -0.791455f, -0.785303f, -0.779073f, -0.772764f, -0.766379f, -0.759917f, -0.753379f,
    -0.746765f, -0.740077f, -0.733315f,  -0.72648f, -0.719572f, -0.712592f,  -0.70554f, -0.698418f,
    -0.691227f, -0.683966f, -0.676637f,  -0.66924f, -0.661776f, -0.654246f, -0.646651f, -0.638991f,
    -0.631267f,  -0.62348f,  -0.61563f, -0.607719f, -0.599747f, -0.591716f, -0.583625f, -0.575475f,
    -0.567269f, -0.559005f, -0.550686f, -0.542311f, -0.533882f,   -0.5254f, -0.516865f, -0.508279f,
    -0.499642f, -0.490955f, -0.482218f, -0.473434f, -0.464602f, -0.455724f,   -0.4468f, -0.437832f,
    -0.428819f, -0.419764f, -0.410667f, -0.401529f,  -0.39235f, -0.383133f, -0.373877f, -0.364583f,
    -0.355254f, -0.345888f, -0.336488f, -0.327055f, -0.317589f, -0.308091f, -0.298562f, -0.289003f,
    -0.279415f,   -0.2698f, -0.260157f, -0.250489f, -0.240795f, -0.231078f, -0.221337f, -0.211574f,
     -0.20179f, -0.191986f, -0.182163f, -0.172321f, -0.162462f, -0.152587f, -0.142697f, -0.132792f,
    -0.122874f, -0.112944f, -0.103002f, -0.093051f, -0.083089f,  -0.07312f, -0.063143f,  -0.05316f,
    -0.043172f, -0.033179f, -0.023183f, -0.013185f, -0.003185f,  0.006815f
};

const float cos_table[TABLE_SIZE] = {
          1.0f,   0.99995f,    0.9998f,   0.99955f,    0.9992f,   0.99875f,  0.998201f,  0.997551f,
     0.996802f,  0.995953f,  0.995004f,  0.993956f,  0.992809f,  0.991562f,  0.990216f,  0.988771f,
     0.987227f,  0.985585f,  0.983844f,  0.982004f,  0.980067f,  0.978031f,  0.975897f,  0.973666f,
     0.971338f,  0.968912f,   0.96639f,  0.963771f,  0.961055f,  0.958244f,  0.955336f,  0.952334f,
     0.949235f,  0.946042f,  0.942755f,  0.939373f,  0.935897f,  0.932327f,  0.928665f,  0.924909f,
     0.921061f,  0.917121f,  0.913089f,  0.908966f,  0.904752f,  0.900447f,  0.896052f,  0.891568f,
     0.886995f,  0.882333f,  0.877583f,  0.872745f,  0.867819f,  0.862807f,  0.857709f,  0.852525f,
     0.847255f,  0.841901f,  0.836463f,  0.830941f,  0.825336f,  0.819648f,  0.813878f,  0.808028f,
     0.802096f,  0.796084f,  0.789992f,  0.783822f,  0.777573f,  0.771246f,  0.764842f,  0.758362f,
     0.751806f,  0.745174f,  0.738469f,  0.731689f,  0.724836f,  0.717911f,  0.710914f,  0.703845f,
     0.696707f,  0.689498f,  0.682221f,  0.674876f,  0.667463f,  0.659983f,  0.652437f,  0.644827f,
     0.637151f,  0.629412f,   0.62161f,  0.613746f,   0.60582f,  0.597834f,  0.589788f,  0.581683f,
      0.57352f,    0.5653f,  0.557023f,   0.54869f,  0.540302f,  0.531861f,  0.523366f,  0.514819f,
      0.50622f,  0.497571f,  0.488872f,  0.480124f,  0.471328f,  0.462485f,  0.453596f,  0.444662f,
     0.435682f,   0.42666f,  0.417595f,  0.408487f,   0.39934f,  0.390152f,  0.380925f,   0.37166f,
     0.362358f,  0.353019f,  0.343646f,  0.334238f,  0.324796f,  0.315322f,  0.305817f,  0.296281f,
     0.286715f,  0.277121f,  0.267499f,   0.25785f,  0.248175f,  0.238476f,  0.228753f,  0.219007f,
     0.209239f,   0.19945f,  0.189641f,  0.179813f,  0.169967f,  0.160104f,  0.150225f,  0.140332f,
     0.130424f,  0.120503f,   0.11057f,  0.100626f,  0.090672f,  0.080708f,  0.070737f,  0.060759f,
     0.050774f,  0.040785f,  0.030791f,  0.020795f,  0.010796f,  0.000796f, -0.009204f, -0.019202f,
      -0.0292f, -0.039194f, -0.049184f, -0.059169f, -0.069148f, -0.079121f, -0.089085f, -0.099041f,
    -0.108987f, -0.118922f, -0.128844f, -0.138755f, -0.148651f, -0.158532f, -0.168397f, -0.178246f,
    -0.188077f, -0.197889f, -0.207681f, -0.217452f, -0.227202f, -0.236929f, -0.246632f, -0.256311f,
    -0.265964f,  -0.27559f, -0.285189f, -0.294759f,   -0.3043f, -0.313811f,  -0.32329f, -0.332736f,
     -0.34215f, -0.351529f, -0.360873f, -0.370181f, -0.379452f, -0.388685f, -0.397879f, -0.407033f,
    -0.416147f, -0.425219f, -0.434248f, -0.443234f, -0.452176f, -0.461073f, -0.469923f, -0.478727f,
    -0.487482f, -0.496189f, -0.504846f, -0.513453f, -0.522008f, -0.530511f, -0.538961f, -0.547358f,
    -0.555699f, -0.563985f, -0.572215f, -0.580387f, -0.588501f, -0.596557f, -0.604552f, -0.612488f,
    -0.620362f, -0.628174f, -0.635923f, -0.643608f,  -0.65123f, -0.658786f, -0.666276f,   -0.6737f,
    -0.681056f, -0.688344f, -0.695563f, -0.702713f, -0.709793f, -0.716801f, -0.723738f, -0.730602f,
    -0.737394f, -0.744111f, -0.750755f, -0.757323f, -0.763815f, -0.770231f,  -0.77657f, -0.782832f,
    -0.789015f, -0.795119f, -0.801144f, -0.807088f, -0.812952f, -0.818735f, -0.824435f, -0.830054f,
    -0.835589f,  -0.84104f, -0.846408f, -0.851691f, -0.856889f, -0.862001f, -0.867027f, -0.871966f,
    -0.876818f, -0.881582f, -0.886258f, -0.890846f, -0.895344f, -0.899753f, -0.904072f, -0.908301f,
    -0.912438f, -0.916485f,  -0.92044f, -0.924302f, -0.928073f,  -0.93175f, -0.935335f, -0.938825f,
    -0.942222f, -0.945525f, -0.948733f, -0.951847f, -0.954865f, -0.957787f, -0.960614f, -0.963345f,
    -0.965979f, -0.968517f, -0.970958f, -0.973302f, -0.975549f, -0.977698f, -0.979749f, -0.981702f,
    -0.983557f, -0.985314f, -0.986972f, -0.988532f, -0.989992f, -0.991354f, -0.992617f,  -0.99378f,
    -0.994844f, -0.995808f, -0.996673f, -0.997438f, -0.998104f, -0.998669f, -0.999135f, -0.999501f,
    -0.999767f, -0.999933f, -0.999999f, -0.999965f, -0.999831f, -0.999597f, -0.999263f, -0.998829f,
    -0.998295f, -0.997661f, -0.996928f, -0.996095f, -0.995162f,  -0.99413f, -0.992998f, -0.991767f,
    -0.990437f, -0.989008f,  -0.98748f, -0.985853f, -0.984128f, -0.982304f, -0.980382f, -0.978362f,
    -0.976244f, -0.974028f, -0.971715f, -0.969305f, -0.966798f, -0.964194f, -0.961494f, -0.958698f,
    -0.955806f, -0.952818f, -0.949735f, -0.946557f, -0.943285f, -0.939918f, -0.936457f, -0.932902f,
    -0.929254f, -0.925513f,  -0.92168f, -0.917755f, -0.913737f, -0.909629f, -0.905429f, -0.901139f,
    -0.896758f, -0.892288f, -0.887729f, -0.883081f, -0.878345f, -0.873521f, -0.868609f, -0.863611f,
    -0.858526f, -0.853356f,   -0.8481f, -0.842759f, -0.837334f, -0.831826f, -0.826234f, -0.820559f,
    -0.814803f, -0.808965f, -0.803046f, -0.797047f, -0.790968f,  -0.78481f, -0.778573f, -0.772259f,
    -0.765867f, -0.759399f, -0.752855f, -0.746236f, -0.739542f, -0.732774f, -0.725932f, -0.719018f,
    -0.712033f, -0.704976f, -0.697848f, -0.690651f, -0.683385f,  -0.67605f, -0.668648f, -0.661179f,
    -0.653644f, -0.646043f, -0.638378f, -0.630649f, -0.622857f, -0.615002f, -0.607087f,  -0.59911f,
    -0.591073f, -0.582978f, -0.574824f, -0.566613f, -0.558345f, -0.550021f, -0.541642f, -0.533209f,
    -0.524722f, -0.516184f, -0.507593f, -0.498952f, -0.490261f, -0.481521f, -0.472732f, -0.463897f,
    -0.455015f, -0.446087f, -0.437115f,   -0.4281f, -0.419041f, -0.409941f, -0.400799f, -0.391618f,
    -0.382397f, -0.373138f, -0.363842f, -0.354509f, -0.345141f, -0.335738f, -0.326302f, -0.316833f,
    -0.307333f, -0.297802f, -0.288241f, -0.278651f, -0.269033f, -0.259389f, -0.249718f, -0.240022f,
    -0.230303f,  -0.22056f, -0.210796f,  -0.20101f, -0.191204f, -0.181379f, -0.171536f, -0.161676f,
      -0.1518f, -0.141908f, -0.132003f, -0.122084f, -0.112153f,  -0.10221f, -0.092258f, -0.082296f,
    -0.072326f, -0.062349f, -0.052365f, -0.042376f, -0.032383f, -0.022387f, -0.012389f, -0.002389f,
     0.007611f,   0.01761f,  0.027608f,  0.037602f,  0.047593f,  0.057579f,   0.06756f,  0.077533f,
     0.087499f,  0.097456f,  0.107403f,   0.11734f,  0.127265f,  0.137177f,  0.147076f,  0.156959f,
     0.166827f,  0.176679f,  0.186512f,  0.196327f,  0.206123f,  0.215898f,  0.225651f,  0.235381f,
     0.245089f,  0.254771f,  0.264428f,  0.274059f,  0.283662f,  0.293237f,  0.302783f,  0.312298f,
     0.321782f,  0.331234f,  0.340653f,  0.350037f,  0.359387f,  0.368701f,  0.377978f,  0.387217f,
     0.396417f,  0.405578f,  0.414698f,  0.423777f,  0.432813f,  0.441806f,  0.450755f,  0.459659f,
     0.468517f,  0.477328f,  0.486091f,  0.494806f,  0.503471f,  0.512085f,  0.520649f,  0.529161f,
     0.537619f,  0.546024f,  0.554374f,  0.562669f,  0.570908f,  0.579089f,  0.587213f,  0.595278f,
     0.603283f,  0.611228f,  0.619112f,  0.626934f,  0.634693f,  0.642389f,   0.65002f,  0.657587f,
     0.665088f,  0.672522f,  0.679889f,  0.687188f,  0.694418f,  0.701579f,   0.70867f,   0.71569f,
     0.722638f,  0.729514f,  0.736317f,  0.743046f,  0.749702f,  0.756282f,  0.762786f,  0.769215f,
     0.775566f,   0.78184f,  0.788035f,  0.794152f,  0.800189f,  0.806147f,  0.812024f,  0.817819f,
     0.823533f,  0.829164f,  0.834713f,  0.840178f,  0.845559f,  0.850855f,  0.856067f,  0.861192f,
     0.866232f,  0.871185f,  0.876051f,  0.880829f,   0.88552f,  0.890121f,  0.894634f,  0.899057f,
      0.90339f,  0.907633f,  0.911785f,  0.915846f,  0.919816f,  0.923693f,  0.927478f,  0.931171f,
      0.93477f,  0.938276f,  0.941688f,  0.945005f,  0.948229f,  0.951357f,   0.95439f,  0.957328f,
      0.96017f,  0.962916f,  0.965566f,  0.968119f,  0.970576f,  0.972935f,  0.975197f,  0.977362f,
     0.979429f,  0.981398f,  0.983268f,  0.985041f,  0.986715f,   0.98829f,  0.989766f,  0.991144f,
     0.992422f,  0.993601f,  0.994681f,  0.995661f,  0.996542f,  0.997323f,  0.998004f,  0.998586f,
     0.999068f,  0.999449f,  0.999731f,  0.999913f,  0.999995f,  0.999977f
};

//Wrap angle to [0, 2Ï€)
static float wrap_angle(float rad) {
    while (rad < 0) rad += 2 * PI;
    while (rad >= 2 * PI) rad -= 2 * PI;
    return rad;
}

// Sine lookup using table
float fsin(float rad) {
    rad = wrap_angle(rad);
    int index = (int)(rad / STEP_RAD);
    if (index >= TABLE_SIZE) index = TABLE_SIZE - 1;
    return sin_table[index];
}

// Cosine lookup using table
float fcos(float rad) {
    rad = wrap_angle(rad);
    int index = (int)(rad / STEP_RAD);
    if (index >= TABLE_SIZE) index = TABLE_SIZE - 1;
    return cos_table[index];
}

static inline void fb_set_pixel(int x, int y, uint16_t color)
{
    if (x < 0 || x >= FB_WIDTH) return;
    if (y < 0 || y >= FB_HEIGHT) return;

    color = (color >> 8) | (color << 8);

    framebuffer[y * FB_WIDTH + x] = color;
}

void fb_clear(uint16_t color)
{
	color = (color >> 8) | (color << 8);
    for (int i = 0; i < FB_WIDTH * FB_HEIGHT; i++)
        framebuffer[i] = color;
}

uint16_t* horizon_get_framebuffer(void)
{
    return framebuffer;
}

static void rotate_vec(float *x, float *y, float *z,
                       float pitch, float roll, float yaw)
{
    float x0 = *x, y0 = *y, z0 = *z;
    float x1, y1, z1;

    // --- Yaw around Z ---
    x1 =  fcos(yaw)*x0 - fsin(yaw)*y0;
    y1 =  fsin(yaw)*x0 + fcos(yaw)*y0;
    z1 =  z0;

    // prepare for next step
    x0 = x1; y0 = y1; z0 = z1;

    // --- Pitch around X ---
    x1 =  x0;
    y1 =  fcos(pitch)*y0 - fsin(pitch)*z0;
    z1 =  fsin(pitch)*y0 + fcos(pitch)*z0;

    x0 = x1; y0 = y1; z0 = z1;

    // --- Roll around Y ---
    x1 =  fcos(roll)*x0 + fsin(roll)*z0;
    y1 =  y0;
    z1 = -fsin(roll)*x0 + fcos(roll)*z0;

    *x = x1;
    *y = y1;
    *z = z1;
}

void draw_navball(float pitch_deg, float roll_deg, float yaw_deg)
{
    float pitch = pitch_deg * (PI / 180.0f);
    float roll  = roll_deg  * (PI / 180.0f);
    float yaw   = yaw_deg   * (PI / 180.0f);

    for (int sy = cy - radius; sy <= cy + radius; sy++) {
        for (int sx = cx - radius; sx <= cx + radius; sx++) {

            int dx = sx - cx;
            int dy = sy - cy;

            // Check if inside circle
            if (dx*dx + dy*dy > radius*radius)
                continue;

            // Convert to normalized sphere coords
            // x^2 + y^2 + z^2 = 1
            float x = dx / (float)radius;
            float y = -dy / (float)radius;  // flip Y (screen coords)
            float t = 1.0f - x*x - y*y;
            if (t < 0) t = 0;
            float z = sqrtf(t);

            // rotate sphere point
            rotate_vec(&x, &y, &z, pitch, roll, yaw);

            // Convert sphere -> texture coordinates (UV)
            float u = (atan2f(z, x) + PI) / (2.0f * PI);
            float v = (asin(y) / PI) + 0.5f;

            // Convert to texture indices
            int tx = (int)(u * NAVBALL_TEXTURE_256_128_WIDTH);
            int ty = (int)(v * NAVBALL_TEXTURE_256_128_HEIGHT);

            if (tx < 0) tx = 0;
            if (tx >= NAVBALL_TEXTURE_256_128_WIDTH) tx = NAVBALL_TEXTURE_256_128_WIDTH - 1;
            if (ty < 0) ty = 0;
            if (ty >= NAVBALL_TEXTURE_256_128_WIDTH) ty = NAVBALL_TEXTURE_256_128_WIDTH - 1;

            uint16_t color =
                navball_texture_256_128[ty * NAVBALL_TEXTURE_256_128_WIDTH + tx];

            fb_set_pixel(sx, sy, color);
        }
    }
}

void framebuffer_draw_circle(uint8_t rad,
                             uint16_t X0, uint16_t Y0,
                             uint16_t color){
	int x = 0;
	int y = rad;
	int d = 3-2*rad;

	while(x<=y){
		fb_set_pixel(X0 + x, Y0 + y, color);
		fb_set_pixel(X0 - x, Y0 + y, color);
		fb_set_pixel(X0 + x, Y0 - y, color);
		fb_set_pixel(X0 - x, Y0 - y, color);

		fb_set_pixel(X0 + y, Y0 + x, color);
		fb_set_pixel(X0 - y, Y0 + x, color);
		fb_set_pixel(X0 + y, Y0 - x, color);
		fb_set_pixel(X0 - y, Y0 - x, color);

		if(d < 0){
			d+=4*x+6;
		}else{
			d+=4*(x-y)+10;
			y--;
		}

		x++;
	}
}
